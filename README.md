# Terraform Proxmox VM Automation üöÄ

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç Terraform-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –º–∞—à–∏–Ω–∞–º–∏ (VM) –≤ Proxmox VE —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ `bpg/proxmox`. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

* –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ VM —á–µ—Ä–µ–∑ Cloud-Init
* –ù–∞—Å—Ç—Ä–æ–π–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU, RAM, —Å–µ—Ç—å, –¥–∏—Å–∫)
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é Ansible inventory.yml
* –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ VM –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
* –ì–∏–±–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–ª–∏ DHCP IP
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API-—Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Proxmox

> **–í–∞–∂–Ω–æ**: –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –∑–∞–ø—É—Å–∫ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
>
> ```
> /home/user/work/terraform/
> ‚îú‚îÄ‚îÄ main.tf
> ‚îú‚îÄ‚îÄ variables.tf
> ‚îú‚îÄ‚îÄ local.tf
> ‚îú‚îÄ‚îÄ output.tf
> ‚îú‚îÄ‚îÄ ansible.tf
> ‚îú‚îÄ‚îÄ inventory.tftpl
> ‚îú‚îÄ‚îÄ provider.tf
> ‚îî‚îÄ‚îÄ terraform.tfvars
> ```
>
> –ê —Å–æ—Å–µ–¥–Ω—è—è –ø–∞–ø–∫–∞ `ansible/inventory/` (–Ω–∞ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ, —á—Ç–æ –∏ `terraform/`):
>
> ```
> /home/user/work/ansible/inventory/inventory.yml
> ```
>
> Inventory –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ `../ansible/inventory/inventory.yml` –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ `path.root`.

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ README

1. [–û–ø–∏—Å–∞–Ω–∏–µ](#–æ–ø–∏—Å–∞–Ω–∏–µ)
2. [–ü—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏](#–ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
4. [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø—Ä–∏–º–µ—Ä—ã (terraform.tfvars)](#–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–∏-–ø—Ä–∏–º–µ—Ä—ã-terraformtfvars)
5. [–ü—Ä–æ–≤–∞–π–¥–µ—Ä Proxmox (provider.tf)](#–ø—Ä–æ–≤–∞–π–¥–µ—Ä-proxmox-providertf)
6. [–û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ—Å—É—Ä—Å VM (main.tf)](#–æ—Å–Ω–æ–≤–Ω–æ–π-—Ä–µ—Å—É—Ä—Å-vm-maintf)
7. [–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è inventory (local.tf + ansible.tf + inventory.tftpl)](#–ª–æ–∫–∞–ª—å–Ω—ã–µ-–¥–∞–Ω–Ω—ã–µ-–∏-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-inventory-localtf--ansibletf--inventorytftpl)
8. [Outputs (output.tf)](#outputs-outputtf)
9. [–ó–∞–ø—É—Å–∫ Terraform](#–∑–∞–ø—É—Å–∫-terraform)
10. [–î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –∏–∑–º–µ–Ω–µ–Ω–∏–µ VM](#–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ--–∏–∑–º–µ–Ω–µ–Ω–∏–µ-vm)
11. [Ansible –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è VM](#ansible-–ø–æ—Å–ª–µ-—Å–æ–∑–¥–∞–Ω–∏—è-vm)
12. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ state](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏-–∏-state)
13. [–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ –º–æ–¥—É–ª–∏](#—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ-–∏-–º–æ–¥—É–ª–∏)
14. [–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)](#—á–∞—Å—Ç—ã–µ-–≤–æ–ø—Ä–æ—Å—ã-faq)
15. [–õ–∏—Ü–µ–Ω–∑–∏—è](#–ª–∏—Ü–µ–Ω–∑–∏—è)

---

## –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç:

* –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å –≤ Terraform –Ω–∞–±–æ—Ä –í–ú –¥–ª—è Proxmox –≤ –≤–∏–¥–µ `map` –æ–±—ä–µ–∫—Ç–æ–≤.
* –ü—Ä–∏ `terraform apply` —Å–æ–∑–¥–∞–≤–∞—Ç—å/–æ–±–Ω–æ–≤–ª—è—Ç—å VM –±–µ–∑ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö.
* –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Ansible inventory.yml –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º VM –∏ –≥—Ä—É–ø–ø–∞–º.
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Cloud-Init —á–µ—Ä–µ–∑ —à–∞–±–ª–æ–Ω, –ª–∏–±–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π cloud-template.
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã CPU/RAM, —Å–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (static –∏–ª–∏ DHCP), BIOS/UEFI, QEMU Guest Agent.
* –ì–∏–±–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å VMID, –∏–º–µ–Ω–∞–º–∏, –≥—Ä—É–ø–ø–∞–º–∏ (–¥–ª—è Ansible), —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∏—Å–∫–æ–≤ –∏ —à–∞–±–ª–æ–Ω–æ–≤.

---

## –ü—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏

* Proxmox VE —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ API: –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å API URL –∏ —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ VM (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ —Ä–æ–ª—å Administrator, –ª–∏–±–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è —Ä–æ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ `/vms/*`).
* Terraform (–≤–µ—Ä—Å–∏—è = 1.11.3).
* –ü—Ä–æ–≤–∞–π–¥–µ—Ä `bpg/proxmox` –≤–µ—Ä—Å–∏–∏ `0.78.2`.
* –ü—Ä–æ–≤–∞–π–¥–µ—Ä `hashicorp/local` –≤–µ—Ä—Å–∏—è `2.5.3`.
* –ù–∞ –º–∞—à–∏–Ω–µ, –æ—Ç–∫—É–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Terraform, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø –≤ Proxmox API (network, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏–ª–∏ `insecure = true`).
* –ü–∞–ø–∫–∞ Ansible-—Å–∏—Ç—É–∞—Ü–∏–∏ —Ä—è–¥–æ–º —Å Terraform: `../ansible/inventory/`.
* –ì–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω (template VM) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Proxmox (—Å Cloud-Init —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º), –∏–ª–∏ –≤—ã –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –æ–±—Ä–∞–∑/–¥–∏—Å–∫ cloud-image –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏.
* SSH-–∫–ª—é—á–∏: –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —à–∞–±–ª–æ–Ω–µ VM, Ansible-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
terraform/                         # –∫–æ—Ä–µ–Ω—å Terraform-–ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ provider.tf                    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ Proxmox —á–µ—Ä–µ–∑ API-—Ç–æ–∫–µ–Ω
‚îú‚îÄ‚îÄ variables.tf                   # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: API, ansible_user, vms map –∏ –¥—Ä.
‚îú‚îÄ‚îÄ terraform.tfvars               # –ó–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–ø—Ä–∏–º–µ—Ä)
‚îú‚îÄ‚îÄ main.tf                        # –†–µ—Å—É—Ä—Å proxmox_virtual_environment_vm —Å for_each
‚îú‚îÄ‚îÄ local.tf                       # –õ–æ–∫–∞–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: host_info, grouping
‚îú‚îÄ‚îÄ ansible.tf                     # –†–µ—Å—É—Ä—Å local_file –¥–ª—è inventory.yml
‚îú‚îÄ‚îÄ inventory.tftpl                # –®–∞–±–ª–æ–Ω inventory –¥–ª—è templatefile
‚îú‚îÄ‚îÄ output.tf                      # Outputs: vm_connections, ansible_inventory_path
‚îî‚îÄ‚îÄ modules/ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)         # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥—É–ª–∏
ansible/                           # –°–æ—Å–µ–¥–Ω—è—è –ø–∞–ø–∫–∞ –¥–ª—è Ansible playbooks
‚îî‚îÄ‚îÄ inventory/
    ‚îî‚îÄ‚îÄ inventory.yml              # –ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω Terraform-–æ–º
```

> **–í–∞–∂–Ω–æ:** –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ `../ansible/inventory/inventory.yml` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `ansible.tf`:
>
> ```hcl
> filename = "${path.root}/${var.ansible_inventory_path}"
> ```
>
> –≥–¥–µ `var.ansible_inventory_path` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `../ansible/inventory/inventory.yml`.

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø—Ä–∏–º–µ—Ä—ã (terraform.tfvars)

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (variables.tf)

* `api_token_id` (string, sensitive) ‚Äî Proxmox API-—Ç–æ–∫–µ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ `user@realm!tokenID=secret`.

* `bpg_api_url` (string, sensitive) ‚Äî URL Proxmox API, –Ω–∞–ø—Ä–∏–º–µ—Ä `https://proxmox.example.com:8006`.

* `ansible_user` (string) ‚Äî SSH-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è Ansible, –Ω–∞–ø—Ä–∏–º–µ—Ä `ubuntu`.

* `vms` (map(object({...}))) ‚Äî –∫–ª—é—á–µ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –æ–ø–∏—Å—ã–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ VM.
  –ü–æ–ª—è –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞:

  * `vm_id` (number) ‚Äî Proxmox VMID –Ω–æ–≤–æ–π VM.
  * `clone_id` (number) ‚Äî VMID —à–∞–±–ª–æ–Ω–∞ (cloud-init template) –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
  * `clone_datastore` (string) ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –≥–¥–µ –ª–µ–∂–∏—Ç —à–∞–±–ª–æ–Ω.
  * `data_store` (string) ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –≥–¥–µ –±—É–¥—É—Ç –ª–µ–∂–∞—Ç—å –¥–∏—Å–∫–∏ –Ω–æ–≤–æ–π VM.
  * `node_name` (string) ‚Äî Proxmox node, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Å–æ–∑–¥–∞—ë—Ç—Å—è VM.
  * `group` (string) ‚Äî –∏–º—è –≥—Ä—É–ø–ø—ã –≤ Ansible inventory, –Ω–∞–ø—Ä–∏–º–µ—Ä `"web-servers"`, `"db-servers"`.
  * `address` (string) ‚Äî IP/–º–∞—Å–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ: `"192.168.1.101/24"`.
  * `gateway` (string) ‚Äî —à–ª—é–∑ —Å–µ—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä `"192.168.1.1"`.
  * `cores` (number) ‚Äî —á–∏—Å–ª–æ CPU-—è–¥–µ—Ä.
  * `sockets` (number) ‚Äî —á–∏—Å–ª–æ —Å–æ–∫–µ—Ç–æ–≤.
  * `ram_min` (number) ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è RAM (balloon) –≤ MB.
  * `ram_max` (number) ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è RAM –≤ MB.
  * `vm_name` (string) ‚Äî –∏–º—è VM –≤ Proxmox. –û–±—ã—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–ª—é—á–æ–º map, –Ω–æ –≤—ã–Ω–µ—Å–µ–Ω–æ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏.

* `ansible_inventory_path` (string) ‚Äî –ø—É—Ç—å –∫ inventory.yml –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞—Ç–∞–ª–æ–≥–∞ Terraform (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `../ansible/inventory/inventory.yml`).

### –ü—Ä–∏–º–µ—Ä terraform.tfvars

```hcl
# Proxmox API
bpg_api_url  = "https://proxmox.example.com:8006"
api_token_id = "terraform@pve!terraform=YOUR_SECRET_TOKEN"

ansible_user = "ubuntu"

# –û–ø–∏—Å–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ VM
vms = {
  "web-01" = {
    vm_id           = 1001
    clone_id        = 9001
    clone_datastore = "local-zfs"
    data_store      = "local-zfs"
    node_name       = "pve"
    group           = "web-servers"
    address         = "192.168.1.101/24"
    gateway         = "192.168.1.1"
    cores           = 2
    sockets         = 1
    ram_min         = 1024
    ram_max         = 2048
    vm_name         = "web-01"
  }
  "db-01" = {
    vm_id           = 1002
    clone_id        = 9002
    clone_datastore = "local-zfs"
    data_store      = "local-zfs"
    node_name       = "pve"
    group           = "db-servers"
    address         = "192.168.1.102/24"
    gateway         = "192.168.1.1"
    cores           = 4
    sockets         = 1
    ram_min         = 2048
    ram_max         = 4096
    vm_name         = "db-01"
  }
  # –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π VM: –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å:
  # "it-01" = { vm_id=1003, clone_id=9003, clone_datastore="local-zfs", data_store="local-zfs", node_name="pve", group="it-service", address="192.168.1.103/24", gateway="192.168.1.1", cores=2, sockets=1, ram_min=1024, ram_max=2048, vm_name="it-01" }
}
```

> üåê **–°–æ–≤–µ—Ç**: —Ö—Ä–∞–Ω–∏—Ç–µ `terraform.tfvars` –≤–Ω–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ú–æ–∂–Ω–æ –∑–∞–≤–µ—Å—Ç–∏ `terraform.tfvars.example` —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

---

## –ü—Ä–æ–≤–∞–π–¥–µ—Ä Proxmox (provider.tf)

```hcl
terraform {
  required_providers {
    proxmox = {
      source  = "bpg/proxmox"
      version = "= 0.78.2"
    }
  }
}

provider "proxmox" {
  endpoint   = var.bpg_api_url
  api_token  = var.api_token_id
  insecure   = true   # –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–ª—è self-signed —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
}
```

* `endpoint` ‚Äî URL Proxmox API.
* `api_token` ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `user@realm!tokenID=secret`.
* `insecure = true` –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É TLS (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–Ω–∞–¥—ë–∂–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö –∏–ª–∏ –ø—Ä–∏ self-signed —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö).

---

## –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ—Å—É—Ä—Å VM (main.tf)

```hcl
resource "proxmox_virtual_environment_vm" "vm" {
  for_each = local.vm_definitions #üí°
  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ò–º—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
  name           = each.value.vm_name # üè∑Ô∏è –ò–º—è VM

  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
  vm_id          = each.value.vm_id        # –£–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π vmid

  # –£–∫–∞–∂–∏—Ç–µ –∏–º—è –ù–æ–¥—ã, –∫–æ—Ç–æ—Ä–æ–º—É –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ VM.
  node_name      = each.value.node_name

  migrate        = true

  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –û–ø–∏—Å–∞–Ω–∏–µ VM
  description    = "Managed by Terraform"

  # ü§ñ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ QEMU Guest Agent
  agent {
    enabled      = true
    trim         = true
    type         = "virtio"
  }

  # üì¶ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  clone {
    datastore_id = each.value.clone_datastore
    vm_id        = each.value.clone_id
    full         = true
  }

  # üß† –ü–∞–º—è—Ç—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ballooning
  memory {
    dedicated    = each.value.ram_max
    floating     = each.value.ram_min
  }

  # üß† CPU: 2 —è–¥—Ä–∞, 1 —Å–æ–∫–µ—Ç, —Ç–∏–ø —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π AES
  cpu {
    cores        = each.value.cores
    sockets      = each.value.sockets
    type         = "x86-64-v2-AES"
  }

  # üåê –°–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  network_device {
    bridge      = "vmbr0"
    # enabled     = true
    # firewall    = false
    # mac_address = 
    model       = "virtio"
    # vlan_id     = each.value.vlan_id # üè∑Ô∏è VLAN Tag (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    # trunks      =
  }

  # üß¨ –¢–∏–ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã –∏ BIOS
  bios           = "ovmf"
  machine        = "q35"

  # ‚òÅÔ∏è cloud-init –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  initialization {
    # 
    datastore_id = each.value.data_store
    # interface     = "scsi2"
    # 
    # dns {
    #   domain      = local.vm_domain
    #   servers     = local.vm_dns
    # }
    # üåê –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Ç—å
    # IP: –µ—Å–ª–∏ address –Ω–µ–ø—É—Å—Ç–æ–π ‚Äî —Å—Ç–∞–≤–∏–º static, –∏–Ω–∞—á–µ DHCP
    ip_config {
      ipv4 {
        address  = each.value.address
        gateway  = each.value.gateway
      }
    }
    # –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ DHCP: –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å ip_config, Proxmox –≤—ã—Å—Ç–∞–≤–∏—Ç DHCP
    
    # user_account {
    #   keys        = [file(local.ssh_key_path)]            # üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ SSH
    #   password    = var.vm_password                       # üîê –ü–∞—Ä–æ–ª—å (–≤–≤–æ–¥–∏—Ç—Å—è –≤—Ä—É—á–Ω—É—é)
    #   username    = local.ssh_user                        # üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å VM
    # }                                    
  }

  # üèÅ –ü–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
  # boot_order    = ["scsi0", "scsi1"]

  # üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–∏—Å–∫–∞
  # disk {
  #   aio           = "io_uring"
  #   backup        = true
  #   cache         = "writethrough"
  #   datastore_id  = "local-zfs"
  #   file_format   = "raw"
  #   interface     = "scsi2"
  #   replicate     = true
  #   size          = "40"
  #   ssd           = true
  # }

  # üíΩ EFI –¥–∏—Å–∫ (–¥–ª—è UEFI –∑–∞–≥—Ä—É–∑–∫–∏) —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—à—å –∑–∞—á–µ–º
  # efi_disk {
  #   datastore_id       = "local-zfs"
  #   file_format        = "raw"
  #   type               = "4m"
  #   pre_enrolled_keys  = true
  # }

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    # l24 - –Ø–¥—Ä–æ Linux 2.4.
    # l26 - –Ø–¥—Ä–æ Linux 2.6 - 5.X.
    # other - –ù–µ—É–∫–∞–∑–∞–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞.
    # solaris - OpenIndiania, OpenSolaris –∏ —è–¥—Ä–æ Solaris.
    # w2k - Windows 2000.
    # w2k3 - Windows 2003.
    # w2k8 - Windows 2008.
    # win7 - Windows 7.
    # win8 ‚Äî Windows 8, 2012 –∏–ª–∏ 2012 R2.
    # win10 - Windows 10 –∏–ª–∏ 2016.
    # win11 - Windows 11
    # wvista - Windows Vista.
    # wxp - Windows XP.
  # operating_system {
  #   type = "l26"
  # }
  
  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –∑–∞—â–∏—Ç—ã –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã. –≠—Ç–æ –æ—Ç–∫–ª—é—á–∏—Ç —É–¥–∞–ª–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã –∏ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∏—Å–∫–æ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false).
  # protection = false          # –º–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å

  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false)
  # reboot        = false       # –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å

  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true).
  # reboot_after_update = true  # –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
  
  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ó–∞–ø—É—Å–∫–∞—Ç—å –ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)
  # started             = false

  # ü§ñ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è SCSI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é virtio-scsi-pci)
    # lsi - LSI Logic SAS1068E.
    # lsi53c810 - LSI Logic 53C810.
    # virtio-scsi-pci - VirtIO SCSI.
    # virtio-scsi-single - VirtIO SCSI (—Å –æ–¥–Ω–æ–π –æ—á–µ—Ä–µ–¥—å—é).
    # megasas - LSI Logic MegaRAID SAS.
    # pvscsi - –ü–∞—Ä–∞–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π SCSI –≤ VMware.
  # scsi_hardware   = "virtio-scsi-pci"

  # üîÅ –ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
  # startup {
  #   order         = 2
  #   up_delay      = 0
  #   down_delay    = 0
  # }

  # (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –í–∫–ª—é—á–µ–Ω–∏–µ USB. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ USB-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –≥–æ—Å—Ç–µ–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true).
  # tablet_device   = true
}
```

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `for_each = var.vms` (map), —á—Ç–æ–±—ã –∑–∞–≤–æ–¥–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –í–ú.
* Cloud-init –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP.
* –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ `user_account` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —é–∑–µ—Ä–∞ –∏ SSH-–∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ Cloud-Init –≤ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–µ—Å–ª–∏ —à–∞–±–ª–æ–Ω VM –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç).
* `clone` –æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å VM-—à–∞–±–ª–æ–Ω (cloud-init template) —Å VMID = `each.value.clone_id` –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ `clone_datastore`.

---

## –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è inventory (local.tf + ansible.tf + inventory.tftpl)

### local.tf

```hcl
locals {
  # –ë–µ—Ä—ë–º –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
  vm_definitions = var.vms
}

locals {
  # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö–æ—Å—Ç–∞—Ö –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
  host_info = {
    for key, vm in proxmox_virtual_environment_vm.vm :
    key => {
      name  = vm.name
      ip    = vm.ipv4_addresses[1][0]
      group = var.vms[key].group
    }
  }
  group_names = distinct([
    for h in values(local.host_info) : h.group
  ])
  grouped = {
    for g in local.group_names :
    g => [
      for h in values(local.host_info) :
      h if h.group == g
    ]
  }
}
```

* `host_info` ‚Äî map –∫–ª—é—á–æ–º (`key` –∏–∑ var.vms) ‚Üí –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏ `name`, `ip`, `group`.
* `vm.ipv4_addresses[1][0]` ‚Äî –∞—Ç—Ä–∏–±—É—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è IP.
* `grouped` ‚Äî map –≥—Ä—É–ø–ø ‚Üí —Å–ø–∏—Å–æ–∫ —Ö–æ—Å—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã.

### inventory.tftpl

–®–∞–±–ª–æ–Ω YAML –¥–ª—è Ansible inventory:

```gotemplate
all:
  children:
    proxmox:
      hosts:
        localhost:
          ansible_host: 192.168.1.54

%{ for grp, hosts in grouped ~}
    ${grp}:
      hosts:
%{ for h in hosts ~}
        ${h.name}:
          ansible_host: ${h.ip}
          ansible_user: ${ansible_user}
%{ endfor ~}
%{ endfor ~}
```

* –û—Ç—Å—Ç—É–ø—ã –≤–∞–∂–Ω—ã: `all:` –Ω–∞ –Ω—É–ª–µ–≤–æ–º —É—Ä–æ–≤–Ω–µ, `children:` –ø–æ–¥ `all`, –∞ –≥—Ä—É–ø–ø—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ `children`.
* `${ansible_user}` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `var.ansible_user`.

### ansible.tf

```hcl
resource "local_file" "ansible_inventory" {
  filename = "${path.root}/${var.ansible_inventory_path}"

  content  = templatefile("${path.module}/inventory.tftpl", {
    grouped      = local.grouped
    ansible_user = var.ansible_user
  })
}
```

* –ü—É—Ç—å: `${path.root}/${var.ansible_inventory_path}`, –≥–¥–µ `var.ansible_inventory_path` –æ–±—ã—á–Ω–æ `../ansible/inventory/inventory.yml`.
* –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Terraform —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ `../ansible/inventory/` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

---

## Outputs (output.tf)

```hcl
output "vm_connections" {
  description = "SSH connection strings for VMs"
  value = {
    for _, vm in proxmox_virtual_environment_vm.vm :
    vm.name => "${var.ansible_user}@${vm.ipv4_addresses[1][0]}"
  }
}

output "ansible_inventory_path" {
  description = "Path to generated inventory"
  value       = local_file.ansible_inventory.filename
}
```

* `vm_connections` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç map: `"vm_name" = "user@IP"`.
* `ansible_inventory_path` ‚Äî –∫—É–¥–∞ –∑–∞–ø–∏—Å–∞–Ω inventory.yml.

---

## –ó–∞–ø—É—Å–∫ Terraform

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥ Terraform:

   ```bash
   cd /home/user/work/terraform
   ```
2. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ `terraform.tfvars` —Å –≤–∞—à–∏–º Proxmox API URL, —Ç–æ–∫–µ–Ω–æ–º –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º VM (—Å–º. –ø—Ä–∏–º–µ—Ä –≤—ã—à–µ).
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ—Å–µ–¥–Ω—è—è –ø–∞–ø–∫–∞ –¥–ª—è inventory —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:

   ```bash
   mkdir -p ../ansible/inventory
   ```
4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:

   ```bash
   terraform init
   ```
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

   ```bash
   terraform validate
   ```
6. –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–∞:

   ```bash
   terraform plan
   ```
7. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:

   ```bash
   terraform apply
   ```

   * Terraform —Å–æ–∑–¥–∞—Å—Ç (–∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç) VM(s) —Å–æ–≥–ª–∞—Å–Ω–æ –æ–ø–∏—Å–∞–Ω–∏—é –≤ `var.vms`.
   * –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è inventory.yml –≤ `../ansible/inventory/inventory.yml`.
   * –í—ã–≤–µ–¥–µ—Ç—Å—è `vm_connections` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `{ vm_name = "user@IP", ... }`.

---

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –∏–∑–º–µ–Ω–µ–Ω–∏–µ VM

* **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ** –Ω–æ–≤–æ–π VM: –≤ `terraform.tfvars` –≤ map `vms` –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä `"it-01"`) –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏. –ó–∞—Ç–µ–º `terraform apply` ‚Äî –Ω–æ–≤–∞—è VM —Å–æ–∑–¥–∞—Å—Ç—Å—è, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
* **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**: –ø—Ä–∞–≤–∏—Ç–µ –ø–æ–ª—è `cores`, `ram_max`, `ram_min` –∏ –ø—Ä. –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞ –≤ `vms`. Terraform –æ–±–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é VM –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è.
* **–ò–∑–º–µ–Ω–µ–Ω–∏–µ IP**: –¥–ª—è —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π VM –º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP —á–µ—Ä–µ–∑ Terraform –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ: Cloud-Init –∑–∞–¥–∞—ë—Ç IP —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å IP (–æ—Å–æ–±—é–µ–Ω–Ω–æ –≤ –ø—Ä–æ–¥–µ), –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Ansible playbook –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è netplan. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å `address` –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º, –∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –¥–µ–ª–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Ansible. –õ–∏–±–æ –≤—Ä—É—á–Ω—É—é —É–¥–∞–ª–∏—Ç—å –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å, –Ω–æ —ç—Ç–æ —Ä–∏—Å–∫–æ–≤–∞–Ω–æ –¥–ª—è prod.
* **–£–¥–∞–ª–µ–Ω–∏–µ** VM: —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ map `vms` ‚Üí –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `terraform apply` Terraform –≤—ã–ø–æ–ª–Ω–∏—Ç destroy —ç—Ç–æ–π VM. –ï—Å–ª–∏ —ç—Ç–æ prod –∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏—Ç—å VM, –º–æ–∂–Ω–æ:

  * –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ `lifecycle { prevent_destroy = true }` –≤–Ω—É—Ç—Ä–∏ —Ä–µ—Å—É—Ä—Å–∞, –Ω–æ —Ç–æ–≥–¥–∞ Terraform –±—É–¥–µ—Ç —Ä—É–≥–∞—Ç—å—Å—è –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–∏—Ç—å. –õ–∏–±–æ –Ω–µ —É–±–∏—Ä–∞—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ map, –∞ ‚Äú–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å‚Äù VM —á–µ—Ä–µ–∑ Ansible/—Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.
* **State**: —Ö—Ä–∞–Ω–∏—Ç–µ state —É–¥–∞–ª—ë–Ω–Ω–æ (S3, Terraform Cloud, etc.) —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π, —á—Ç–æ–±—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ –ø—É—Ç–∞–ª–∏—Å—å.

---

## Ansible –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è VM

1. Inventory –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ `../ansible/inventory/inventory.yml`.
2. –ü–µ—Ä–≤—ã–µ –∑–∞–¥–∞—á–∏ Ansible (playbook) –º–æ–≥—É—Ç:

   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å hostname (`hostname` module).
   * –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é —Å–µ—Ç—å (—à–∞–±–ª–æ–Ω netplan Jinja2).
   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω—É–∂–Ω—ã–µ –ø–∞–∫–µ—Ç—ã: `neofetch`, `zabbix-agent`, `htop`, `curl` –∏ –¥—Ä.
   * –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å VM, —á—Ç–æ–±—ã —Å–µ—Ç—å –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞.
3. Playbook –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å inventory, –µ—Å–ª–∏ IP/hostname –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.
4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ö—Ä–∞–Ω–∏—Ç—å playbooks —Ä—è–¥–æ–º: `../ansible/playbooks/`, –∞ inventory –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è Terraform-–æ–º.

–ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ playbook (`../ansible/playbooks/setup_vm.yml`):

```yaml
---
- hosts: all
  become: true
  vars:
    netplan_template_src: "../templates/netplan-static.j2"
  tasks:
    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Configure netplan
      template:
        src: "{{ netplan_template_src }}"
        dest: /etc/netplan/01-netcfg.yaml
      notify:
        - Apply netplan

    - name: Install base packages
      apt:
        name:
          - neofetch
          - zabbix-agent
          - htop
          - curl
        state: present
      register: install_pkgs

    - name: Restart if needed
      reboot:
        when: install_pkgs.changed
        msg: "Reboot after package install"
  
  handlers:
    - name: Apply netplan
      command: netplan apply
```

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ `ansible/`:

```bash
ansible-playbook -i inventory/inventory.yml playbooks/setup_vm.yml
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ state

* **Terraform state**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–¥–∞–ª—ë–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Terraform Cloud, S3+DynamoDB lock, etc.), —á—Ç–æ–±—ã –∏–∑–±–µ–≥–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –ø–æ—Ç–µ—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
* **API-—Ç–æ–∫–µ–Ω**: —Ö—Ä–∞–Ω–∏—Ç–µ `terraform.tfvars` –≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –¥–æ–±–∞–≤—å—Ç–µ –≤ `.gitignore`. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Vault –∏–ª–∏ CI/CD —Å–µ–∫—Ä–µ—Ç—ã.
* **SSH-–∫–ª—é—á–∏**: –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ —à–∞–±–ª–æ–Ω–µ VM –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º snippet; –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ/CI.
* **insecure = true**: –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ—Å—Ç–∞/–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏. –í –ø—Ä–æ–¥–µ –ª—É—á—à–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É TLS: –∑–∞–≥—Ä—É–∑–∏—Ç—å CA-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Proxmox –∏ —É–∫–∞–∑–∞—Ç—å `cacert` –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ, –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è.
* **lifecycle.prevent\_destroy**: –¥–ª—è prod VM –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.

---

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ –º–æ–¥—É–ª–∏

* –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–∫—Ä—É–∂–µ–Ω–∏–π (dev/test/prod), –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è VM –≤ –º–æ–¥—É–ª—å `modules/proxmox-vm`, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π –æ–±—ä–µ–∫—Ç –æ–ø–∏—Å–∞–Ω–∏—è VM, –∏ –≤—ã–∑—ã–≤–∞—Ç—å –º–æ–¥—É–ª—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π —Å —Ä–∞–∑–Ω—ã–º–∏ tfvars.
* –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: –¥–∏—Å–∫–æ–≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö (disk blocks), VLAN (`vlan_id`), tags, —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ snapshot, firewall –∏ –¥—Ä.
* –î–æ–±–∞–≤–∏—Ç—å input-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞ cloud-init (usernames, –ø–∞—Ä–æ–ª–∏, SSH keys) –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏—Ö –≤ block `initialization.user_account`.
* –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–º–ø–æ—Ä—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤: —á–µ—Ä–µ–∑ Terraform resource import –¥–ª—è —à–∞–±–ª–æ–Ω–Ω—ã—Ö VM.
* CI/CD: –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å `terraform plan/apply` –≤ pipeline, –ø—Ä–æ–≤–µ—Ä—è—Ç—å formatting (`terraform fmt`), linting (`tflint`), security scan.

---

## –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)

* **Q:** –ö–∞–∫ –∑–∞–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏, –Ω–æ –Ω–µ –º–µ–Ω—è—Ç—å –µ–≥–æ –ø–æ—Ç–æ–º?
  **A:** Cloud-Init –∑–∞–¥–∞—ë—Ç IP –æ–¥–∏–Ω —Ä–∞–∑. –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –Ω–µ –º–µ–Ω—è–µ—Ç `address` –≤ Terraform. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ —á–µ—Ä–µ–∑ Ansible (netplan), –∞ Terraform –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á.
* **Q:** –ú–æ–∂–Ω–æ –ª–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–µ—Ç–µ–≤—ã–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏?
  **A:** –î–∞: –¥–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ `network_device` —Å `id = 0`, `id = 1` –∏ —Ç.–¥., —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –Ω—É–∂–Ω—ã–µ bridge/vlan. –í `initialization` Cloud-Init –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ —á–µ—Ä–µ–∑ Ansible.
* **Q:** –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å Terraform state?
  **A:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–¥–∞–ª—ë–Ω–Ω—ã–π backend (Terraform Cloud, AWS S3+lock, GCS, Azure Storage –∏ —Ç.–¥.).
* **Q:** –ù—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —à–∞–±–ª–æ–Ω –≤—Ä—É—á–Ω—É—é?
  **A:** –î–∞: –ø–µ—Ä–µ–¥ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ Cloud-Init —à–∞–±–ª–æ–Ω VM: –æ–±—ã—á–Ω–æ —Å–æ–∑–¥–∞—é—Ç VM, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –û–° –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ autoinstall, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç cloud-init –ø–∞–∫–µ—Ç, –æ—á–∏—â–∞—é—Ç –ª–æ–≥–∏, –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç VM –≤ —à–∞–±–ª–æ–Ω (`qm template VMID`).
* **Q:** –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –¥–∏—Å–∫, VLAN, firewall?
  **A:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ—Å—É—Ä—Å `proxmox_virtual_environment_vm` –±–ª–æ–∫–∞–º–∏ `disk`, `network_device` —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ bpg/proxmox (—Å–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: [https://github.com/bpg/terraform-provider-proxmox](https://github.com/bpg/terraform-provider-proxmox)).
* **Q:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é VM, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é —á–µ—Ä–µ–∑ Terraform?
  **A:** –õ–∏–±–æ –≤—Ä—É—á–Ω—É—é (GUI –∏–ª–∏ `qm set`), –ª–∏–±–æ —á–µ—Ä–µ–∑ `null_resource`+`local-exec`, –ª–∏–±–æ –¥–æ–∂–¥–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
* **Q:** –ö–∞–∫ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ Proxmox API?
  **A:** –í–∫–ª—é—á–∞–π—Ç–µ `TF_LOG=DEBUG terraform apply`, —Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ API, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞ –≤ Proxmox (role, scope).
* **Q:** –ö–∞–∫ –∑–∞–¥–∞—Ç—å hostname VM?
  **A:** –®–∞–±–ª–æ–Ω Cloud-Init –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª–µ hostname. –í –æ—Å–Ω–æ–≤–Ω–æ–º hostname –∑–∞–¥–∞—é—Ç —á–µ—Ä–µ–∑ Ansible –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è VM.
* **Q:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ snapshot?
  **A:** Terraform –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∏–∑ map. Snapshot –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Proxmox API –∏ Terraform, –Ω–æ —á–∞—Å—Ç–æ –¥–µ–ª–∞—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ (Ansible, —Å–∫—Ä–∏–ø—Ç—ã).
* **Q:** –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Terraform –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–º Proxmox (nodes, storage)?
  **A:** –° –ø–æ–º–æ—â—å—é –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ bpg/proxmox –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã VM, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –≤–æ–∑–º–æ–∂–Ω–æ network config, –Ω–æ –Ω–µ –≤–µ—Å—å Proxmox cluster. –î–ª—è —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ª—É—á—à–µ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ Ansible. Terraform –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è VM lifecycle.

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω ‚Äú–∫–∞–∫ –µ—Å—Ç—å‚Äù –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫.
–í—ã –º–æ–∂–µ—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å README –∏ Terraform-–∫–æ–¥ –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã.

---
